<!doctype html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>WormGPT — Logs</title>
    <meta name="description" content="Realtime logs viewer for WormGPT chats" />
    <style>
      :root{
        --bg:#0f172a;--card:#0b1220;--muted:#94a3b8;--accent:#06b6d4;--accent-2:#7c3aed;--glass: rgba(255,255,255,0.04);
        --glass-2: rgba(255,255,255,0.02);--success:#10b981;--danger:#ef4444
      }
      *{box-sizing:border-box}
      body{margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#071024 0%, #061428 60%);color:#e6eef8;min-height:100vh}
      .wrap{max-width:1100px;margin:32px auto;padding:28px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 8px 30px rgba(2,6,23,0.6)}
      header{display:flex;align-items:center;justify-content:space-between;gap:16px}
      h1{margin:0;font-size:20px;letter-spacing:-0.2px}
      .sub{color:var(--muted);font-size:13px}
      .controls{display:flex;gap:8px;align-items:center}
      .btn{background:var(--glass);color:var(--accent);border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
      .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;border:0}
      .status{font-size:13px;color:var(--muted)}

      .panel{display:grid;grid-template-columns:1fr 360px;gap:20px;margin-top:18px}
      .card{background:var(--card);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}

      .list{height:64vh;overflow:auto;border-radius:8px}
      .log{padding:12px;border-bottom:1px solid var(--glass-2);display:flex;gap:12px}
      .meta{min-width:160px;color:var(--muted);font-size:13px}
      .msg{flex:1}
      .who{font-weight:700}
      .text{margin-top:6px;color:#dbeafe;white-space:pre-wrap}
      .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:12px;color:var(--muted)}

      .right{display:flex;flex-direction:column;gap:12px}
      label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
      input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#e6eef8}
      form .row{display:flex;gap:8px}

      footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}

      .empty{padding:36px;text-align:center;color:var(--muted)}
      .controls .switch{display:flex;align-items:center;gap:8px}

      /* modal */
      .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(to bottom, rgba(2,6,23,0.6), rgba(2,6,23,0.85));z-index:40}
      .modal.active{display:flex}
      .modal .box{width:900px;max-width:95%;background:#071024;border-radius:12px;padding:18px;color:#e6eef8}
      .modal .box pre{white-space:pre-wrap;background:rgba(255,255,255,0.02);padding:12px;border-radius:8px}

      @media (max-width:980px){.panel{grid-template-columns:1fr}.meta{display:none}}
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div>
          <h1>WormGPT — Realtime Logs</h1>
          <div class="sub">Menangkap pertanyaan & jawaban chatbot secara realtime. Sumber: <span class="pill">https://vercel.com/danar-firdhans-projects/testing</span></div>
        </div>

        <div class="controls">
          <button id="connectBtn" class="btn">Connect (SSE)</button>
          <button id="refresh" class="btn">Refresh</button>
          <div class="switch"><label class="status" id="status">Connecting...</label></div>
        </div>
      </header>

      <div class="panel">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <strong>Activity</strong>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="search" placeholder="Cari teks..." style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:#e6eef8" />
              <button id="download" class="btn">Download</button>
            </div>
          </div>

          <div id="list" class="list"></div>
          <div id="empty" class="empty" style="display:none">Belum ada logs.</div>
        </div>

        <aside class="right">
          <div class="card">
            <strong>Stream / Fallback</strong>
            <p class="sub">Coba sambungkan ke stream (realtime). Jika tidak tersedia, akan fallback ke polling setiap 3s.</p>
            <label>Custom SSE URL (optional)</label>
            <input id="sseUrl" placeholder="https://your-host/stream" />
            <div style="height:8px"></div>
            <label>Auto-scroll</label>
            <select id="autoscroll"><option value="true">On</option><option value="false">Off</option></select>
          </div>

          <div class="card">
            <strong>Test sender</strong>
            <p class="sub">Kirim test log ke endpoint <code>/api/logs</code> pada deploy ini.</p>
            <form id="postForm">
              <label>Question</label>
              <textarea name="question" rows="2">Halo, ini test log</textarea>
              <label>Answer</label>
              <textarea name="answer" rows="3">Ini jawaban contoh</textarea>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button type="submit" class="btn primary">Kirim</button>
                <button type="button" id="clear" class="btn">Clear</button>
              </div>
            </form>
          </div>
        </aside>
      </div>

      <footer>Forwarding listener: <a href="https://logswormhistory.vercel.app/" target="_blank" style="color:var(--accent)">logswormhistory.vercel.app</a></footer>
    </div>

    <div id="modal" class="modal"><div class="box"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><strong>Detail</strong><button id="closeModal" class="btn">Close</button></div><pre id="modalContent"></pre></div></div>

    <script>
      // Realtime / polling logs viewer
      const listEl = document.getElementById('list');
      const emptyEl = document.getElementById('empty');
      const statusEl = document.getElementById('status');
      const connectBtn = document.getElementById('connectBtn');
      const refreshBtn = document.getElementById('refresh');
      const sseUrlInput = document.getElementById('sseUrl');
      const searchInput = document.getElementById('search');
      const downloadBtn = document.getElementById('download');
      const modal = document.getElementById('modal');
      const modalContent = document.getElementById('modalContent');
      const closeModal = document.getElementById('closeModal');

      let logs = [];
      let es = null;
      let pollTimer = null;

      function formatTime(ts){ try{ return new Date(ts).toLocaleString() }catch(e){return ts} }

      function render(){
        const q = (searchInput.value || '').toLowerCase();
        const visible = logs.filter(l => {
          if(!q) return true;
          return JSON.stringify(l).toLowerCase().includes(q);
        });

        if(visible.length === 0){ listEl.innerHTML=''; emptyEl.style.display='block'; return }
        emptyEl.style.display='none';

        listEl.innerHTML = visible.map(l => {
          const time = formatTime(l.timestamp || l.time || Date.now());
          const who = l.source || (l.role || 'user');
          const question = escapeHtml(truncate(l.question||l.contents||'', 250));
          const answer = escapeHtml(truncate(l.answer||l.response||'', 900));
          const ip = l.ip || '-';
          const loc = (l.lat && l.lon) ? `${l.lat}, ${l.lon}` : (l.city ? `${l.city}${l.region? ', '+l.region:''}` : '-');
          return `\n            <div class="log" data-id="${escapeHtml(l.id||'')}">\n              <div class="meta">${time}<div class="pill" style="margin-top:8px">IP: ${escapeHtml(ip)}</div>\n                <div style=\"margin-top:6px;font-size:12px;color:var(--muted)\">${escapeHtml(loc)}</div>\n              </div>\n              <div class="msg">\n                <div class="who">Q — ${question}</div>\n                <div class="text">A — ${answer}</div>\n              </div>\n            </div>`;
        }).join('');

      // small helpers
      function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]}) }
      function truncate(s,n){ if(!s) return ''; return s.length>n? s.slice(0,n)+'…': s }

      }

      // fetch logs (GET /api/logs)
      async function fetchLogs(){
        try{
          const res = await fetch('/api/logs');
          if(!res.ok) throw new Error(res.status + ' ' + res.statusText);
          const data = await res.json();
          logs = Array.isArray(data) ? data : (data.logs || []);
          render();
          statusEl.textContent = 'Connected (polling)';
        }catch(err){
          statusEl.textContent = 'Fetch error: ' + err.message;
        }
      }

      async function postTest(form){
        const body = { question: form.question.value, answer: form.answer.value, timestamp: Date.now() };
        try{
          const res = await fetch('/api/logs',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(body)});
          if(!res.ok) throw new Error(''+res.status);
          form.question.value='';form.answer.value='';
          await fetchLogs();
        }catch(e){ alert('Failed: '+e.message) }
      }

      // init
      document.getElementById('postForm').addEventListener('submit', e=>{ e.preventDefault(); postTest(e.target) });
      document.getElementById('clear').addEventListener('click', ()=>{ document.querySelector('#postForm textarea[name=question]').value=''; document.querySelector('#postForm textarea[name=answer]').value=''; });
      refreshBtn.addEventListener('click', ()=>fetchLogs());
      downloadBtn.addEventListener('click', ()=>{ const blob = new Blob([JSON.stringify(logs, null, 2)], {type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='logs.json'; a.click(); });

      connectBtn.addEventListener('click', ()=>{
        if(es){ es.close(); es=null; connectBtn.textContent='Connect (SSE)'; statusEl.textContent='Disconnected'; return }
        const url = sseUrlInput.value || '/api/logs/stream';
        try{
          es = new EventSource(url);
          es.onopen = ()=>{ statusEl.textContent='Connected (SSE)'; connectBtn.textContent='Disconnect'; }
          es.onmessage = (ev)=>{
            try{ const d = JSON.parse(ev.data); logs = d.logs || []; render(); }catch(e){ console.warn(e) }
          }
          es.onerror = (e)=>{ statusEl.textContent='SSE error, falling back to polling'; es.close(); es=null; pollTimer = setInterval(fetchLogs,3000); }
        }catch(e){ statusEl.textContent='SSE not supported'; pollTimer = setInterval(fetchLogs,3000); }
      });

      // start polling initially
      fetchLogs();
      pollTimer = setInterval(fetchLogs, 5000);

      // modal
      listEl.addEventListener('click', (ev)=>{
        const el = ev.target.closest('.log'); if(!el) return; const id = el.getAttribute('data-id'); const entry = logs.find(x=> (x.id||'')===id) || logs[0]; modalContent.textContent = JSON.stringify(entry, null, 2); modal.classList.add('active');
      });
      closeModal.addEventListener('click', ()=> modal.classList.remove('active'));

